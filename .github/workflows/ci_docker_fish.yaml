name: Docker Build and Release

# è§¦å‘å™¨ï¼šä»…å½“ä¸€ä¸ªæ–°çš„ Release è¢«å‘å¸ƒæ—¶è¿è¡Œ
on:
  release:
    types: [published]

env:
  REGISTRY: ghcr.io
  # ${{ github.repository }} ä¼šè‡ªåŠ¨è§£æä¸º "owner/repo-name"
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      # packages: write æ˜¯æ¨é€åˆ° GitHub Container Registry (ghcr.io) æ‰€éœ€çš„æƒé™
      packages: write

    steps:
    - name: Checkout repository
      # æ­¤æ­¥éª¤ä¼šæ£€å‡ºä¸å‘å¸ƒçš„ Release ç›¸å…³è”çš„é‚£ä¸ª Git æ ‡ç­¾çš„ä»£ç 
      uses: actions/checkout@v4

    # ğŸŸ¢ [æ–°å¢æ­¥éª¤] è®¾ç½® QEMU ä»¥æ”¯æŒè·¨å¹³å°æ„å»º (ARM64)
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata for Docker
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          # ä» Git æ ‡ç­¾ä¸­æå– SemVer ç‰ˆæœ¬å· (e.g., v1.2.3 -> 1.2.3, 1.2, 1)
          # è¿™æ˜¯ Release æµç¨‹çš„æ ¸å¿ƒ
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=semver,pattern={{major}}

          # æ·»åŠ ä¸€ä¸ªåŸºäº commit SHA çš„çŸ­æ ‡ç­¾ï¼Œç”¨äºç²¾ç¡®è¿½è¸ª
          type=sha,format=short

          # ä»…å½“å‘å¸ƒçš„ Release ä¸æ˜¯é¢„å‘å¸ƒç‰ˆæœ¬ (pre-release) æ—¶ï¼Œæ‰æ·»åŠ  "latest" æ ‡ç­¾
          type=raw,value=latest,enable=${{ !github.event.release.prerelease }}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        # ç”±äºæ­¤å·¥ä½œæµåªåœ¨ Release æ—¶è¿è¡Œï¼Œæˆ‘ä»¬æ€»æ˜¯å¸Œæœ›æ¨é€é•œåƒ
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        # ğŸŸ¢ [ä¿®æ”¹æ­¤å¤„] æ·»åŠ  linux/arm64 æ”¯æŒ
        platforms: linux/amd64,linux/arm64
